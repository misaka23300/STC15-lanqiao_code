C51 COMPILER V9.60.7.0   MAIN                                                              12/10/2025 17:56:40 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main\main.c OPTIMIZE(8,SPEED) BROWSE INCDIR(.\include) DEBUG OBJECTEXTEN
                    -D PRINT(.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          /**
   2           * @file main.c
   3           * @brief 程序入口与基于1ms定时器的任务调度
   4           * @details 使用 1ms 定时器中断作为基础时基，通过简单计时器变量实现多任务周
             -执行。
   5           *          调度思路：
   6           *            1. 在中断中每 1ms 对任务计时器自增；
   7           *            2. 在主循环中判断各任务计时器是否达到其周期，达到则执行任务并
             -零计时器。
   8           * @date 2025-12-09
   9           */
  10          
  11          #include "main.h"
  12          
  13          /* 定时型任务创建 
  14          
  15          1. 创建枚举，记录执行间隔
  16          2. 创建变量，记录定时
  17          3. while主循环判断是否达到间隔
  18          4. 1ms定时器中断，对变量自加
  19          */
  20          
  21          /**
  22           * @brief 任务时间间隔枚举（单位：ms）
  23           * @details LED 与按键调度周期定义为常量，方便调整与统一管理。
  24           */
  25          enum {
  26              LED_TIME = 10,
  27              KEY_TIME = 9,
  28          };
  29          
  30          /**
  31           * @brief LED 任务控制块类型
  32           */
  33          typedef struct {
  34              uint8_t time;
  35          } LED;
  36          
  37          LED led;
  38          /**
  39           * @brief 按键任务控制块类型
  40           * @details 包含计时器和按键扫描结果字段。
  41           */
  42          typedef struct {
  43              uint8_t time;
  44              uint8_t press;
  45          } KEY;
  46          
  47          KEY key;
  48          /* 实例化任务控制块变量（保持原来代码中对 led.time / key.time 的访问不变） */
  49          
  50          
  51           /**
  52           * @brief 程序入口
C51 COMPILER V9.60.7.0   MAIN                                                              12/10/2025 17:56:40 PAGE 2   

  53           * @details 初始化硬件后进入主循环，基于计时器变量周期性调用各任务。
  54           * @note 该函数不返回，应为 MCU 主循环。
  55           */
  56          void main()
  57          {
  58   1          boot_init();
  59   1      
  60   1      
  61   1          while(1) {
  62   2              if (led.time == LED_TIME) {
  63   3                  led.time = 0;
  64   3                  led_display();
  65   3              }
  66   2      
  67   2              if (key.time == KEY_TIME) {
  68   3                  key.time = 0;
  69   3                  key_task();
  70   3              }
  71   2          }
  72   1      }
  73          
  74          /**
  75           * @brief 定时器1 中断处理，1ms 基准（interrupt 3）
  76           * @details 在中断中执行短周期显示刷新(seg_display)并对任务计时器自增。
  77           *          建议仅执行必要的短耗时操作以保证中断及时返回。
  78           */
  79          void timer_1_1ms() interrupt 3
  80          {
  81   1          seg_display();
  82   1          if (led.time < LED_TIME) {
  83   2              led.time++;
  84   2          }
  85   1          if (key.time < KEY_TIME) {
  86   2              key.time++;
  87   2          }
  88   1      }
  89          
  90          
  91          
  92          void key_task()
  93          {
  94   1          
  95   1      
  96   1          key.press = key_scan();
  97   1          if (key.press != 99) {
  98   2              seg_set(0, key.press / 10);
  99   2              seg_set(1, key.press % 10);
 100   2              
 101   2          }
 102   1          
 103   1          
 104   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    141    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      3    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
C51 COMPILER V9.60.7.0   MAIN                                                              12/10/2025 17:56:40 PAGE 3   

END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
